#!/bin/sh

# <copyright>
#  
#  Copyright 2001-2004 BBNT Solutions, LLC
#  under sponsorship of the Defense Advanced Research Projects
#  Agency (DARPA).
# 
#  You can redistribute this software and/or modify it under the
#  terms of the Cougaar Open Source License as published on the
#  Cougaar Open Source Website (www.cougaar.org).
# 
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
#  "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
#  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
#  A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
#  OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
#  LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
#  OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#  
# </copyright>


#
# Node runs a cougaar society node
# usage:  Node [-v] [-preoptions ...] Nodename[.ini] [-postoptions ...]
#   -v  outputs debugging information to stdout during the script's execution
#   -preoptions are passed as VM arguments, generally -D args, but must start with "-"
#   Nodename[.ini] The name of the Node to run.  the ".ini" suffix is tolerated but discouraged.
#   -postoptions are passed as Node arguments (e.g. after the node classname) and may be of
#      any form understood by the Node class
# 
# The environment variable $COUGAAR_INSTALL_PATH should be set to the installed location
# of Cougaar if not set, the script will check $CIP and then will attempt to 
# guess based on where the Node script is located.
#
# !!!WARNING TO THOSE MODIFYING THIS SCRIPT!!!  Arguments must be separated by
# newlines!

scriptname=`basename $0`
verbose=
nodename=

if [ -z "$COUGAAR_INSTALL_PATH" ]; then
    if [ "$CIP" ]; then
	COUGAAR_INSTALL_PATH="$CIP";
    else
	s=`echo "$0" | sed -e 's,/bin/.*,,'`
	if [ x$s != x ] ; then
	    COUGAAR_INSTALL_PATH=$s
	else
	    echo "Error: Could not find COUGAAR_INSTALL_PATH!";
	    exit;
	fi
    fi
fi


while [ x"$1" != x ]; do
  case $1 in
    -v) verbose=1
	shift
	continue;;
    -h) echo "Usage: Node [-v] [-preoptions ...] [<society>.xml] <Nodename>[.ini] [otherOptions ...]"
        echo "  if <society>.xml is specified, Node will take the Node specification from the xml file."
        echo "  -v run the script in verbose mode"
	echo "Environment variables:"
	echo "  COUGAAR_INSTALL_PATH is where cougaar is installed.  The script will attempt to discover"
	echo "     the correct value if not specified"
	echo "  CIP is an alias for COUGAAR_INSTALL_PATH"
	exit;;
    *) 	break;;
  esac
done

socname=
if [ x"$1" != x"${1%.xml}" ]; then
  socname="${1%.xml}"
  shift
fi

nodename="${1%.ini}"
shift

if [ x"$nodename" == x ]; then
    echo "Warning: defaulting Nodename to \"Node\"";
    nodename="Node"
fi

# postarg handling - not sure why I cannot just use $*, even with IFS
postargs=
while [ x"$1" != x ]; do
    postargs="$postargs
$1"
    shift
done

# add your cougaar options here (or on the command line):
# To quiet the complainingLP:
# -Dorg.cougaar.planning.ldm.lps.ComplainingLP.level=0
coptions="-Dorg.cougaar.core.agent.startTime=08/10/2005 00:05:00"

# vm arguments to adjust (defaults are given).  You can tune the VM performance
# by fooling with these values... or you can render your society unrunnable.
vmargs="-Xmx768m
-Xms64m
-Xoss256k"

# environment arguments - e.g. set timezone to GMT to avoid confusion
eargs="-Duser.timezone=GMT";

# Specify the name of the node to run.
nodeargs="-Dorg.cougaar.node.name=$nodename"

# extend the bootclasspath with cougaar's persistence support
bootargs="-Xbootclasspath/p:${COUGAAR_INSTALL_PATH}/lib/javaiopatch.jar"

# name of the node class
nodeclass="org.cougaar.core.node.Node"

allargs="${bootargs}
${vmargs}
${eargs}
${preargs}
${nodeargs}
${coptions}"

if [ $verbose ]; then allargs="-v
$allargs"; fi

if [ x"$socname" != x ]; then
  #uncomment this to turn on validation
  #xmlvalidate="-Dorg.cougaar.core.node.validate=true"
  xmlvalidate=""
  xmlargs="-Dorg.cougaar.core.node.InitializationComponent=XML
-Dorg.cougaar.society.file=${socname}.xml
$xmlvalidate"
  allargs="$allargs
$xmlargs"
fi
IFS=$'\n'

exec /bin/sh $COUGAAR_INSTALL_PATH/bin/boost $allargs $nodeclass $postargs

