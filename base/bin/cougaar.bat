@echo off
 
REM "<copyright>"
REM " "
REM " Copyright 2001-2004 BBNT Solutions, LLC"
REM " under sponsorship of the Defense Advanced Research Projects"
REM " Agency (DARPA)."
REM ""
REM " You can redistribute this software and/or modify it under the"
REM " terms of the Cougaar Open Source License as published on the"
REM " Cougaar Open Source Website (www.cougaar.org)."
REM ""
REM " THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS"
REM " "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT"
REM " LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR"
REM " A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT"
REM " OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,"
REM " SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT"
REM " LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,"
REM " DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY"
REM " THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT"
REM " (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE"
REM " OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE."
REM " "
REM "</copyright>"

REM ""
REM "Launch a Cougaar node"
REM ""
REM ""
REM "For usage, run with zero parameters or with --help"
REM ""

REM "Find the bootstrap jar"
if not "%CIP%" == "" goto L_1
set CIP=%COUGAAR_INSTALL_PATH%
if not "%CIP%" == "" goto L_1
echo "\$COUGAAR_INSTALL_PATH not set"
exit 1
:L_1
if exist %CIP%\lib\bootstrap.jar goto L_2
echo "Unable to find boostrap.jar in %%CIP%%: %CIP%"
:L_2

REM "Get the java command line based on our arguments"

REM "DOS lacks a simple 'exec `java ..`', so we're forced to"
REM "create a temporary .BAT file, run it, then delete it"

REM "Create a unique temporary file."
REM "Note that DOS lacks both a random file name utility *and* an"
REM "atomic file create-if-not-exists!  A timestamp-based file"
REM "name would fail in exactly the race conditions we care about."
REM "So, we iterate over potental file names and use a same-named"
REM "directory as a lock."
set base=%TEMP%
if "%base%" == "" set base=.
set base=%base%\cougaar_exec
set iter=
:loop_top
if exist %base%%iter%.bat goto loop_next
mkdir %base%%iter% > NUL
if %ERRORLEVEL% == 0 goto loop_end
:loop_next
set iter="%iter%x"
goto loop_top
:loop_end
set exec=%base%%iter%.bat
echo @echo off > %exec%
rmdir %base%%iter%

echo @REM Generated by Cougaar.bat! >> %exec%

java -classpath %CIP%\lib\bootstrap.jar org.cougaar.bootstrap.CommandLine -w %* >> %exec%
if not %ERRORLEVEL% == 0 goto end

call %exec%

REM "If we get here, the above java processes was cleanly stopped."
REM "But, if the batch script was killed, we won't get here, which"
REM "means we won't clean up %TEMP%, but that should be fine."
:end
del %exec%
