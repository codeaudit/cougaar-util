<HTML>
<HEAD>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1252">
<META NAME="Generator" CONTENT="Microsoft Word 97">
<TITLE>LDMQuery Plugin</TITLE>
<META NAME="Template" CONTENT="C:\MSOffice\Office\html.dot">
</HEAD>
<BODY LINK="#0000ff" VLINK="#800080">

<FONT SIZE=5><P ALIGN="CENTER">LDMQuery Plugin</P>
</FONT><FONT SIZE=2><P>&nbsp;</P>
</FONT><U><FONT FACE="Arial"><P>Overview</P>
</U></FONT><P>The LDMQuery Plugin is used to query contemporary (external) databases for asset and property information. Once retrieved, the information is stored in the given cluster’s Log Plan as assets, prototypes and properties. Assets and properties can then be retrieved by other cluster Plugins using the interfaces available to the Log Plan.</P>
<P>The LDMQuery Plugin queries either local or remote data sources using Java Database Connectivity (JDBC). This Plugin builds on existing functionality found in the current LDMSQLPlugin and QueryHandler class, but adds the capability to be able to query alternative data sources when a given data source is unreachable. This Plugin also makes use of the QueryHandler classes, with slight modifications to incorporate this multiple database approach. In future releases, the LDM Query Plugin may provide a Layered Initialization mechanism for querying databases using mechanisms other than JDBC.</P>
<FONT SIZE=2><P>&nbsp;</P>
</FONT><U><FONT FACE="Arial"><P>LDMQuery Plugin Behavior</P>
</U></FONT><P>When the LDMQuery Plugin first initializes, it retrieves a query file, configuration file, and a UIC parameter. The database configuration file contains information about the databases that are to be used by the given cluster. This is an example of such a configuration file:
<table border=1><tr><td>
<pre>
DB_NUM# = 1
DB_NAME = jdbc:oracle:thin:@199.170.235:1521:orcl1
DB_DRIVER = oracle.jdbc.driver.OracleDriver
USER = system
PASSWORD = manager
MIN_IN_POOL = 1
MAX_IN_POOL = 4
TIMEOUT = 1
NUMBER_OF_TRIES = 2
DB_NUM# = 2
DB_NAME = jdbc:oracle:thin:@199.170.235.158:1521:jtav
DB_DRIVER = oracle.jdbc.driver.OracleDriver
USER = system
PASSWORD = manager
MIN_IN_POOL = 1
MAX_IN_POOL = 4
TIMEOUT = 1
NUMBER_OF_TRIES = 3
DB_NUM# = 3
DB_NAME = jdbc:oracle:thin:@199.170.235.61:1521:alpdump
DB_DRIVER = oracle.jdbc.driver.OracleDriver
USER = system
PASSWORD = manager
MIN_IN_POOL = 1
MAX_IN_POOL = 4
TIMEOUT = 1
NUMBER_OF_TRIES = 2
</pre>
</td></tr></table>
<P>&nbsp;</P>
<P>The database name is composed of the JDBC url and actual database name. The database driver represents the type of JDBC driver to use for a given database. The user id and password are required in order to successfully connect to the database. The minimum and maximum number represents the minimum and maximum number of connections for a given database pool. The number of tries specifies the number of attempts that should be made to connect to a given database. The timeout value indicates the time (in seconds) in which the given driver will wait when logging into a database. This value is also used to determine if certain database connections are stale, deadlocked, or are in a hanging state.</P>
<P>The LDMQuery Plugin also uses a query file. The query file lists all of the possible queries that may be used when retrieving prototype and property information for a given cluster. The query file is used to associate various queries with a given prototype or property. Lines starting with "%" indicate the start of a query section and the rest of the line specifies the specific QueryHandler class to use. Lines beginning with the word "DB_NAME" represent the database that is to be used to create the given prototype, property or asset within the Log Plan. Proceeding each database line is a corresponding query line. This query line represents the query that is associated with the given prototype or property provider class. This is an example of such a query file:
<table border=1><tr><td>
<pre>
# non live eiger jtav query
%SQLAssetPrototypeProvider
Assetclass = PhysicalAsset

%ECPropertyProvider
DB_NAME1=jdbc:oracle:thin:@199.170.235.113:1521:orcl1query1  = \
  select substr(model_desc||' '||lin_desc,1,30) model_desc, \
  length, width, height, max_wgt, \
  sq_ft, cubic_ft, cgo_cat_cd \
  from equipment_characteristics \
  where nsn = (:nsns) \
  and lin_index=(select min(lin_index) \
  from equipment_characteristics \
  where nsn = (:nsns) )

DB_NAME2=jdbc:oracle:thin:@199.170.235.158:1521:jtavquery2  = \
  select substr(model_desc||' '||lin_desc,1,30) model_desc, \
  length, width, height, max_wgt,
  sq_ft, cubic_ft, cgo_cat_cd \
  from equipment_characteristics \
  where nsn = (:nsns) \
  and lin_index=(select min(lin_index) \
  from equipment_characteristics \
  where nsn = (:nsns) )

DB_NAME3 = jdbc:oracle:thin:@199.170.235.61:1521:alpdump

query3 = select substr(model_desc||' '||lin_desc,1,30) model_desc, \
  length, width, height, max_wgt, \
  sq_ft, cubic_ft, cgo_cat_cd \
  from equipment_characteristics \
  where nsn = (:nsns) \
  and lin_index=(select min(lin_index) \
  from equipment_characteristics \
  where nsn = (:nsns) )

%Global
DB_NAME1=jdbc:oracle:thin:@199.170.235.113:1521:orcl1
query1 = select nsn, sum(qty_oh), nomenclature \
  from jtav_equipment \
  where substr(nsn,5,13) in (:niins) \
  and uic4 in (:uics) \
  group by nsn, nomenclature
DB_NAME2=jdbc:oracle:thin:@199.170.235.158:1521:jtav
query2 = select nsn, sum(qty_oh), nomenclature \
  from jtav_equipment \
  where substr(nsn,5,13) in (:niins) \
  and uic4 in (:uics) \
  group by nsn, nomenclature
DB_NAME3 = jdbc:oracle:thin:@199.170.235.61:1521:alpdump
query3 = select nsn, sum(qty_oh), nomenclature \
  from jtav_equipment \
  where substr(nsn,5,13) in (:niins) \
  and uic4 in (:uics) \
  group by nsn, nomenclature
  
%SQLAssetCreator
niins = '010871095' 

%SQLAggregateAssetCreator
niins = '011007672'
</pre>
</td></tr></table>
<U><P>LDMQuery Plugin Details</P>
</U><P>The new classes created and used by this query mechanism are as follows:</P>
<OL>

<LI>LDMQueryPlugin</LI>
<LI>LDMConnectionDriver</LI>
<LI>LDMConnectionPool</LI>
<LI>LDMConnection</LI></OL>

<P>The following files are files that currently exist in the COUGAAR infrastructure, but were modified (some of them slightly), so that the LDMQueryPlugin and the LDMSQLPlugin could both still be used.</P>
<TABLE BORDER CELLSPACING=1 CELLPADDING=7 WIDTH=619>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P><B>File Name</B></TD>
<TD WIDTH="55%" VALIGN="TOP">
<B><P>Change Description</B></TD>
</TR>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P>AircraftPropertyProvider.java</TD>
<TD WIDTH="55%" VALIGN="TOP">
<P>Changed to call the appropriate executeSQL or executeQuery method based on the type of Plugin that is currently in use (LDMQueryPlugin or LDMSQLPlugin)</TD>
</TR>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P>ECPropertyProvider.java</TD>
<TD WIDTH="55%" VALIGN="TOP">
<P>Changed to call the appropriate executeSQL or executeQuery method based on the type of Plugin that is currently in use (LDMQueryPlugin or LDMSQLPlugin)</TD>
</TR>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P>PeriodicQuery.java</TD>
<TD WIDTH="55%" VALIGN="TOP">
<P>Changed to call the appropriate executeSQL or executeQuery method based on the type of Plugin that is currently in use (LDMQueryPlugin or LDMSQLPlugin)</TD>
</TR>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P>SQLAssetPrototypeProvider.java</TD>
<TD WIDTH="55%" VALIGN="TOP">
<P>Changed to support an additional the LDMQueryPlugin and the LDMSQLPlugin (Slight modification)</TD>
</TR>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P>SQLCommAirCreator.java</TD>
<TD WIDTH="55%" VALIGN="TOP">
<P>Changed to support an additional the LDMQueryPlugin and the LDMSQLPlugin (Slight modification)</TD>
</TR>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P>SQLAssetCreator.java</TD>
<TD WIDTH="55%" VALIGN="TOP">
<P>Changed to support an additional the LDMQueryPlugin and the LDMSQLPlugin (Slight modification)</TD>
</TR>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P>QueryHandler.java</TD>
<TD WIDTH="55%" VALIGN="TOP">
<P>Changed to support an additional the LDMQueryPlugin and the LDMSQLPlugin</TD>
</TR>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P>SQLAggregateAssetCreator.java</TD>
<TD WIDTH="55%" VALIGN="TOP">
<P>Changed to support an additional the LDMQueryPlugin and the LDMSQLPlugin (Slight modification)</TD>
</TR>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P>SQLGlobalAirProtoCreator.java</TD>
<TD WIDTH="55%" VALIGN="TOP">
<P>Changed to support an additional the LDMQueryPlugin and the LDMSQLPlugin (Slight modification)</TD>
</TR>
<TR><TD WIDTH="45%" VALIGN="TOP">
<P>SQLGDSSCreator.java</TD>
<TD WIDTH="55%" VALIGN="TOP">
<P>Changed to support an additional the LDMQueryPlugin and the LDMSQLPlugin (Slight modification)</TD>
</TR>
</TABLE>

<FONT SIZE=2><P>&nbsp;</P>
</FONT><P>The LDMQuery Plugin class, which inherits from the LDMEssentialPlugin class, represents the actual Plugin that gets instantiated by a given cluster at initialization. The cluster infrastructure initializes this Plugin by calling the setupSubscriptions method. </P>
<P>Once called, the Plugin parses the database files located in the given directory. As the database information is parsed, the LDMConnectionDriver object is instantiated for each unique JDBC url.</P>
<P>The LDMConnectionDriver object does the following:</P>
<OL>

<LI>Loads the <CODE>Driver</CODE> class passed to the constructor by the calling program. </LI>
<LI>Initializes a <CODE>LDMConnectionPool</CODE> object for the connections with the JDBC url, login user ID, and login password, along with other information found in the &lt;database_type_name&gt;.cfg file. This information is passed to the constructor by the LDMQuery Plugin.</LI></OL>

<P>&nbsp;</P>
<P>The LDMConnectionPool class makes connections available to the calling program with the getConnection method. This method searches for an available connection in the connection pool. If no connection is available from the pool, a new connection is created, as long at the maximum pool size has not been reached. If a connection is available from the pool, the connection is returned to the calling program. This class shall make a number of attempts to connect to the database before returning a null to the caller indicating that the connection failed. The number of attempts depends on the number that is specified in the configuration file.</P>
<P>The LDMConnection class contains information about the actual connection. It implements the Connection interface found in the JDK sql package. It also provides additional information, such as if a connection is available for leasing or not. It is used by the LDMConnectionPool and returns the actual connection along with information about whether the connection is available for use. A series of passthru methods are implemented within this class. These methods of required because the LDMConnection class implements the JDK Connection class. </P>
<P>Once the database configuration file is parsed and the appropriate database connection driver/pool objects are instantiated, the database query file is parsed. When a query handler name is read in, which is the text that follows the %, the corresponding query handler object is created. All remaining database names and SQL queries associated with the given query handler are stored in the query handler properties. After the parsing of the query files has been completed, the appropriate query handlers are started and each query handler calls the executeSQL method passing in the sql to be used, database name associated with the sql, and a handle to it’s own class instance. The LDMQueryPlugin searches for the database driver that matches the given database name. It then calls the connect method to retrieve a connection from the LDMConnectionDriver object. Once a connection is returned, the given SQL statement is executed to perform the appropriate query. The information that is returned from the database query is then passed back to the calling query handler class. If the connection fails, the query handler is notified and must then execute one of the alternative queries stored in its properties list.</P>
<FONT SIZE=2><P>&nbsp;</P></FONT></BODY>
</HTML>
