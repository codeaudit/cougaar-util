<html>
<head>
<title>Cougaar Servlets</title>
</head>
<body bgcolor="white">
<p>
<center><h1>Cougaar Servlets</h1></center>
<p>
These notes introduce the Cougaar Servlet support.
<p>
<ol>

<li>
Prior versions of Cougaar used "PSP"s, which were similar to
servlets but used a non-standard API and were generally more
difficult to develop.  Developers of "legacy" PSPs should read
this document <i>first</i> to learn the high-level servlet concepts, 
and (later) they should also read the
<a href="PSPPortingGuide.html"
>PSP Porting Guide</a>.
<p>
Note that all PSP support has been deprecated
(<a href=
"https://www.alpine.bbn.com/bugzilla/show_bug.cgi?id=1017"
>bug 1017</a>) 
and will be removed 
from Cougaar in the future, so new developers should just learn the
servlet APIs, and PSP-developers <b>must</b> port the PSPs that they'll 
need to use in the future.  There's no need to port PSPs that will not
be used in the immediate future.
</li><p>

<li>
See the <a href="PortedPSPs.html">table of Cougaar servlets</a> for a 
list of standard Cougaar servlets (e.g. the "/tasks" servlet).
</li><p>

<li>
(Optionally) see the 
<a href="../../webserver/doc/install.html"
>webserver installation document</a>
for server configuration notes.
<p>
By default the servlet server is enabled to run HTTP on port 8800,
so this is not required.
<p>
The optional server configuration steps in the
<a href="../../webserver/doc/install.html"
>webserver installation document</a>
include:
<ul>
<li>Selection of a different HTTP port (other than 8800)</li>
<li>Security options, such as HTTPS and client-authentication.</li>
</ul>
</li><p>

<li>
On Internet Explorer you should disable the
"friendly HTML error page" option:
<pre>
  tools-&gt;Internet Options-&gt;Advanced-&gt;Show Friendly HTTP error messages == UNCHECKED
</pre>
otherwise some helpful "no such path" error response messages will
be hidden by your browser.
</li><p>

<li>
There are a handful of built-in servlets that are always loaded.  These
are useful for both general users and developers.
<p>
The examples below assume:
<ul>
  <li>Host "localhost" is running a cougaar node with HTTP support
      on port 8800.</li>
  <li>On "localhost:8800" there's an agent named "foo".</li>
  <li>Agent "foo" has an internally registered (user-developed)
      servlet with path "/hello".  See the example section below
      for a sample "HelloServlet" implementation.</li>
  <li>There's no agent named "junk" in the society.</li>
  <li>Suppose that there's a second cougaar node on host "x.com"
      and HTTP port 9876.</li>
</ul>
<p>
Here are the built-in servlets:
<ul>
  <li><a href="http://localhost:8800">http://localhost:8800</a><br>
      <a href="http://localhost:8800/">http://localhost:8800/</a><br>
      Generate a simple help page, plus links to some of the
      built-in servlets listed below.<br>
      This is the best place to start.
    </li><p>
  <li><a href="http://localhost:8800/agents"
       >http://localhost:8800/agents</a><br>
      List agent names.  This servlet supports any combination of
      these URL-parameters:
      <ul>
        <li>"?local" -- list local agent names (default)</li>
        <li>"?all"   -- list all agent names (instead of "?local")</li>
        <li>"?html"  -- generate a pretty html page (default) </li>
        <li>"?text"  -- generate plain text, one name per line
                        (instead of "?html")</li>
      </ul>
      For example,
      <a href="http://localhost:8800/agents?all&amp;text"
      >http://localhost:8800/agents?all&amp;text</a>
      will generate a plain-text listing of all agent names in the
      society.
      <p>
      More precisely, the "?all" option will list all
      <i>web-registered</i> agents in the society, so if some agents
      in a society have HTTP/HTTPS disabled (via the "-D" properties
      described in the
      <a href="../../webserver/doc/install.html"
      >webserver/doc/install.html</a>)
      then they will
      not be listed.  By default all nodes and agents are registered,
      so this is typically not an issue.
      </li><p>
   <li><a href="http://localhost:8800/$foo"
       >http://localhost:8800/$foo</a><br>
       <a href="http://localhost:8800/$foo"
       >http://localhost:8800/$foo/</a><br>
       Generate a help page for agent "foo", with a link to the
       "/$foo/list" servlet described below.
       </li><p>
   <li><a href="http://localhost:8800/$foo/list"
       >http://localhost:8800/$foo/list</a><br>
       List all the servlet paths registered on agent "foo".  In
       our example this should list:<ol>
         <li>/$foo/agents</li>
         <li>/$foo/hello</li>
         <li>/$foo/list</li>
       </ol>
       </li><p>
   <li><a href="http://localhost:8800/$foo/agents"
       >http://localhost:8800/$foo/agents</a><br>
       Run the "/agents" servlet on the node that is running agent
       "foo".  This is handy for listing co-located agents.
       </li><p>
   <li><a href="http://localhost:8800/$foo/hello"
       >http://localhost:8800/$foo/hello</a><br>
       Invoke agent "foo"'s "/hello" servlet.  This is how all
       user-developed servlets are invoked.
       </li><p>
   <li><a href="http://x.com:9876/$foo/hello"
       >http://x.com:9876/$foo/hello</a><br>
       This request to the wrong node is automatically redirected
       to
       <a href="http://localhost:8800/$foo/hello"
       >http://localhost:8800/$foo/hello</a>.
       In general a
       client can use any node's server as a "gateway" to
       all the agents in the distributed society and depend
       upon the built-in redirection to send the request
       to the right node.
       </li><p>
   <li><a href="http://localhost:8800/$/hello"
       >http://localhost:8800/$/hello</a><br>
       <a href="http://localhost:8800/hello"
       >http://localhost:8800/hello</a><br>
       This lets the node pick a <b>random</b> local agent
       and pass the "/hello" request to that agent.
       <p>
       This is only useful when you know (<i>a priori</i>) that
       all the agents have the same path registered and that they'll
       all generate an equivalent response.  For example, the "/tasks"
       servlet generates the same generic HTML frame no matter
       which agent it is started in.  The latter "/$/" is preferred,
       since it is more explicit that a random agent is being
       selected.
       </li><p>
   <li><a href="http://localhost:8800/$junk/hello"
       >http://localhost:8800/$junk/hello</a><br>
       This will generate an HTML error page with all local agent
       names and the "/hello" path tacked onto the end.  This
       is a bit of a hack, but can be used as a shortcut to calling
       "/agents" then typing one of the listed agent names and the
       "/hello".  Like the "/$/" above, this assumes that all the
       local agents have the "/hello" path registered.
       </li><p>
   <li><a href="http://localhost:8800/robots.txt"
       >http://localhost:8800/robots.txt</a><br>
       Generate this hard-coded response:<pre>
          User-agent: *
          Disallow: /
       </pre> which is used to exclude search engines, such as
       "google", from scanning cougaar web pages.
       </li><p>
</ul>
</li>

<li>
<a name="ini">
All user-developed servlets are loaded like plugins, with ".ini"-style
"plugin = " lines.  There are also corresponding CSMART recipes that
can be used.
<p>
Here's an example ".ini" line for loading the "/tasks" servlet:<pre>
   plugin = org.cougaar.core.servlet.SimpleServletComponent(org.cougaar.planning.servlet.PlanViewServlet, /tasks)
</pre>
The "SimpleServletComponent" listed above, plus use of the raw
"ServletService" within Components in general (e.g. plugins), is
described later in this document.
</li><p>

<li>
For servlet developers, the standard Servlet API is used by the
"ServletService".  You <i>don't</i> need to be an expert at the
Servlet API to begin writing Cougaar Servlets, but here are some
tutorials and reference documentation:
<ul>
  <li><a href=
  "http://java.sun.com/docs/books/tutorial/servlets"
  >Sun's Servlet tutorial</a></li>
  <li><a href=
  "http://www.apl.jhu.edu/~hall/java/Servlet-Tutorial"
  >Tutorial based upon the "Core Servlets" book</a></li>
  <li><a href=
  "http://www.novocode.com/doc/servlet-essentials"
  >Another good tutorial</a></li>
</ul>
The API includes methods for parsing URL parameters, reading passed data,
writing to the response output (text or data), etc.
</li><p>

<li>
<a name="api">
The ServletService API (with lots of javadocs) is in:
<br><tt>
&nbsp; core/src/org/cougaar/core/servlet/ServletService.java
</tt><br>
This defines the basic "register(servlet, path)" API.
</li><p>

<li>
<a name="examples">
There are several example servlets in the core's "examples"
directory:<br><tt>
&nbsp;  core/examples/org/cougaar/core/examples/servlet/*
</tt><br>
See the "README" in that directory for details.
<p>
The examples cover:
<ul><p>
  <li>Use of the "SimpleServletComponent" to load non-cougaar
      servlets, such as the typical "Hello world!" servlet
      that is found in virtually all tutorials.
      <p>
      There's also a "SnoopServlet", which illustrates the use
      of all the "HttpServletRequest" methods in a single servlet
      (i.e. it prints the request headers, cookies, host:port,
      path, URL-parameters, etc).  Developers who are new to the 
      Servlet APIs will likly find this to be invaluble!
      </li><p>
  <li>Use of the SimpleServletComponent to provide the
      "SimpleServletSupport" API to the servlet, which
      makes it easy to write servlets that just need to:
      <ul>
        <li>know the agent's name</li>
        <li>query the blackboard</li>
        <li>know the names of all the agents in the society</li>
      </ul>
      However, this API is fairly limited, so it should only
      be used by very simple servlets that just need to peek
      at the blackboard.  Users should <i>not</i> subclass
      SimpleServletComponent; see the other options listed
      below.
      </li><p>
  <li>Extension of the "BaseServletComponent" class,
      which allows a servlet to access the full ServiceBroker
      and BindingSite capabilities.
      <p>
      The ServiceBroker and BindingSite are provided as protected
      fields of the BaseServletComponent:
      <pre>
         protected ServiceBroker serviceBroker;
         protected BindingSite bindingSite;
      </pre>
      Your subclass can use the serviceBroker within its "load()" and
      "unload()" methods to obtain services, and then later use the
      services to handle servlet requests.  See the example
      "LogServiceComponent" for an example access of the
      LoggingService.
      <p>
      Subclasses of BaseServletComponent are loaded just like
      plugins.  For example:
      <pre>
         plugin = org.cougaar.core.examples.servlet.HelloBaseServletComponent
      </pre>
      Subclasses of BaseServletComponent must define these two methods:
      <pre>
         protected String getPath() {
            // return a string path to the servlet, such as "/test"
         }
         protected Servlet createServlet() {
            // create the servlet instance, which can be an inner class.
         }
      </pre>
      Optionally one can additionally make the path a parameter to
      the component (instead of hard-coding it):
      <pre>
        private String path;
        public void setParameter(Object o) {
            // get the list of string parameters from the ".ini" line
            List l = (List) o;
            // take the first argument as the path
            this.path = (String) l.get(0);
        }
        protected String getPath() {
           return path;
        }
        ..
      </pre>
      and your ".ini" would look like:
      <pre>
         plugin = YourClass(/test)
      </pre>
      The above can be generalized to tack on whatever parameters
      you need, just like a plugin's use of parameters. 
      </li><p>
  <li>Use of the "raw" ServletService API, which allows
      any Component to register servlets.
      <p>
      Both the SimpleServletComponent and BaseServletComponent
      described above are simply clients of the ServletService API,
      and are only intended to <i>(maybe)</i> make the development of
      servlets a little easier.  If they seem to get in your way,
      just take a look at their code and cut-&amp;-paste something
      together.
      <p>
      For example, the ServletService API has been used
      directly within plugins to provide a "hybrid"
      plugin/servlet, such as the GLM's "GLSInitServlet".
      </li><p>
</ul>
Note that these example classes are not compiled into the
"core.jar"; you'll need to compile them yourself.
<p>
There are several example servlets included in Cougaar, such
as the "/tasks" servlet
(<tt>org.cougaar.planning.servlet.PlanViewServlet</tt>).
Developers can examine these "real" servlets as additional
examples.
</li><p>

<li>
<a name="httpMethod">
Here are some important notes on the use "GET v.s. POST v.s. PUT" as
the HTTP request method:
<p>
HTML-generating servlets should only use "doGet(..)", where HTML
"&lt;a hrefs=..&gt;" are the same as before, but HTML FORMs should
look like: <pre>
  &lt;form method="GET" .. /&gt;  <i>not POST!</i>
  ... <i>various "input" and "select" statements</i>
  &lt;/form&gt;
</pre>
<p>
Java clients that simply use URL-parameters can without writing
to the servlet can remain as-is, since HTTP GET works fine.
Java clients that need to upload data to the servlet, such as
serialized Java Objects or a streamed 'dialog', should use PUT
instead of the default POST method: <pre>
   UrlConnection uc = ...;
   ((HttpUrlConnection) uc).setRequestMethod("PUT");
   OutputStream os = uc.getOutputStream();
   ...  <i>// usual "upload-data" code</i>
</pre> and the servlet should support the "doPut(..)" method.  Note
that the UrlConnection's setting of the "GET v.s. POST" method is
not well documented in the Sun javadocs.
<p>
The reason for the above "use GET &amp; use PUT instead of POST"
nonsense is that POST requests will not be redirected between nodes
(typically the POST data is lost), whereas GET and PUT will be correctly
redirected.  The exact redirection rules are in the HTTP specification
and built into the browser/URLConnection code itself:
<ul>
  <li><a href=
  "http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html"
  >HTTP/1.1 spec on request methods</a></li>
  <li><a href=
  "http://ppewww.ph.gla.ac.uk/~flavell/www/post-redirect.html"
  >Further notes on POST redirection</a></li>
</ul>
</li><p>

</ol>
</body></html>
